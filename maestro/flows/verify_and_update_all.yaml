appId: dev.zapstore.app
---
# =============================================================
# Sub-flow: Verify updates visible and execute Update All
#
# Navigates to the Updates tab, dismisses any "All done" banner,
# asserts "Update All" is visible, taps it, and waits for all
# updates to complete.
#
# After completion, "All done (N updated)" banner is visible.
# =============================================================

# Dismiss Android notification permission dialog if shown
- runFlow:
    when:
      visible: "Allow"
    commands:
      - tapOn: "Allow"

- tapOn:
    text: ".*Tab 2 of 3"
    label: "Tap Updates tab"

# "All done (N installed)" banner and "Update All" are mutually exclusive.
# If the banner is showing (from the install phase), dismiss it first.
- runFlow:
    when:
      visible: ".*All done.*"
    commands:
      - tapOn:
          text: ".*All done.*"

# Wait for updates to load
- assertVisible:
    text: ".*Update All.*"

# Badge/section count must match the number of apps prepared in the script
- assertVisible:
    text: ".*Updates\\s*${APP_COUNT}.*"

- tapOn:
    text: ".*Update All.*"
    label: "Tap Update All"
    retryTapIfNoChange: true

# On some Samsung builds the first tap can be swallowed by transient UI state.
# Retry once if the Update All button is still present.
- runFlow:
    when:
      visible:
        text: ".*Update All.*"
    commands:
      - waitForAnimationToEnd
      - tapOn:
          text: ".*Update All.*"
          label: "Retry Tap Update All"
          retryTapIfNoChange: true

# Wait for the "All done (N updated)" banner.
# Require the completion banner to avoid false positives from generic "Up to date" sections.
- assertVisible:
    text: ".*All done.*updated.*"

appId: dev.zapstore.app
---
# =============================================================
# Sub-flow: Install an older version of an app
#
# Expects to be on the app detail page with the app uninstalled.
# Scrolls to "Debug: All Versions", expands it, and installs
# the second version in the list (the first older version).
#
# Handles (in order):
#   - Android system "Update" confirmation dialog
#   - Amber signing request ("Accept")
#   - Samsung "Trust and install app" security dialog
#   - Android system "Install" dialog
#   - Samsung "package analysis error" dialog
#
# After completion, the older version is installed ("Open" visible).
# =============================================================

# Dismiss Android notification permission dialog if shown
- runFlow:
    when:
      visible: "Allow"
    commands:
      - tapOn: "Allow"

- scrollUntilVisible:
    element:
      text: ".*All Versions.*"
    direction: DOWN
    speed: 95
    timeout: 12000

- tapOn:
    text: ".*All Versions.*"
    label: "Expand versions list"

# Scroll to make more versions visible
- scroll

# Move list viewport so the install action targets an older entry,
# not the top/latest one.
- scroll

# Use "below" selector relative to visible version rows:
#   index 0 = first visible version install
#   index 1 = next (older) version install
- tapOn:
    text: "Install"
    below:
      text: ".*Version .*"
    index: 1
    label: "Install older version"

# Android may open security settings to allow unknown sources.
# Enable and return, then trigger install again.
- runFlow:
    when:
      visible: "Install unknown apps"
    commands:
      - tapOn: "Allow from this source"
      - pressKey: back
      - scroll
      - tapOn:
          text: "Install"
          below:
            text: ".*Version .*"
          index: 1
          label: "Install older version (retry after allowing unknown source)"

# Wait for the first dialog to appear.
- assertVisible:
    text: "(?:.*Do you want to (?:update|install).*|.*(?:Install|Update) this app\\?.*|Accept|Trust and install app)"

# Amber may ask to sign a request during install
- runFlow:
    when:
      visible: "Accept"
    commands:
      - tapOn: "Accept"

# Samsung security dialog (may not appear if source already trusted)
- runFlow:
    when:
      visible: "Trust and install app"
    commands:
      - tapOn: "Trust and install app"

# Handle Android system install dialog
- runFlow:
    when:
      visible:
        text: "(?:.*Do you want to install.*|.*Install this app\\?.*)"
    commands:
      - tapOn: "Install"

# Handle Android system update/downgrade dialog
- runFlow:
    when:
      visible:
        text: "(?:.*Do you want to update.*|.*Update this app\\?.*)"
    commands:
      - tapOn: "Update"

# Dismiss Samsung dialog if it appeared
- runFlow:
    when:
      visible: "OK"
    commands:
      - tapOn: "OK"

# Some devices do not surface "Open" reliably in the same layout.
# The script validates the installed version via adb after this flow.
- waitForAnimationToEnd

# Return to app root (tab bar) so next app can be searched immediately.
# Some devices stay on app-detail after install.
- pressKey: back
- runFlow:
    when:
      notVisible: ".*Tab 1 of 3"
    commands:
      - pressKey: back

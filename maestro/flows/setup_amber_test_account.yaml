appId: com.greenart7c3.nostrsigner
---
# =============================================================
# Sub-flow: Ensure test account is active in Amber
# =============================================================

# Handle Amber permission modals that may appear immediately on launch
- runFlow:
    when:
      visible: "Permission Needed"
    commands:
      - tapOn: "Allow"

- runFlow:
    when:
      visible:
        text: "Allow Amber to send you notifications\\?"
    commands:
      - tapOn: "Allow"

- runFlow:
    when:
      visible:
        text: "Let app always run in background\\?"
    commands:
      - tapOn: "Allow"

# Wait for Amber to load (main screen or onboarding)
- assertVisible:
    text: "(?:Applications|Use your private key|Select Account|Permission Needed|Allow Amber to send you notifications\\?|Let app always run in background\\?)"

# Re-handle transient permission modals in case they reappear
- runFlow:
    when:
      visible: "Permission Needed"
    commands:
      - tapOn: "Allow"

- runFlow:
    when:
      visible:
        text: "Allow Amber to send you notifications\\?"
    commands:
      - tapOn: "Allow"

- runFlow:
    when:
      visible:
        text: "Let app always run in background\\?"
    commands:
      - tapOn: "Allow"

# Scenario A: Amber main screen ("Applications")
- runFlow:
    when:
      visible: "Applications"
    commands:
      - tapOn:
          text: "Accounts"
          label: "Tap Accounts bottom tab"
      - assertVisible: "Select Account"
      - runFlow:
          when:
            notVisible: "npub1lhr"
          commands:
            - tapOn: "Add New Account"
            - assertVisible: "Use your private key"
            - tapOn: "Use your private key"
            - assertVisible: "Nsec / private key"
            - tapOn:
                text: "Nsec / private key"
                label: "Tap nsec input field"
            - runFlow:
                when:
                  visible: "Try out your stylus"
                commands:
                  - tapOn: "Cancel"
            - inputText: "${NOSTR_TEST_NSEC}"
            - tapOn: "Next"
            - assertVisible: "Finish"
            - tapOn: "Finish"
            - assertVisible:
                text: "(?:Applications|Don.?t allow|Allow Amber to send you notifications\\?|Let app always run in background\\?)"
            - runFlow:
                when:
                  visible:
                    text: "Don.?t allow"
                commands:
                  - tapOn:
                      text: "Don.?t allow"
            - runFlow:
                when:
                  visible:
                    text: "Let app always run in background\\?"
                commands:
                  - tapOn: "Allow"
            - assertVisible: "Applications"
      - runFlow:
          when:
            visible: "Select Account"
          commands:
            - tapOn:
                text: "npub1lhr"
                label: "Select test account"
            - runFlow:
                when:
                  visible: "Permission Needed"
                commands:
                  - tapOn: "Allow"
            - pressKey: back

# Scenario B: Fresh onboarding
- runFlow:
    when:
      visible: "Use your private key"
    commands:
      - tapOn: "Use your private key"
      - assertVisible: "Nsec / private key"
      - tapOn:
          text: "Nsec / private key"
          label: "Tap nsec input field"
      - runFlow:
          when:
            visible: "Try out your stylus"
          commands:
            - tapOn: "Cancel"
      - inputText: "${NOSTR_TEST_NSEC}"
      - tapOn: "Next"
      - assertVisible: "Finish"
      - tapOn: "Finish"
      - assertVisible:
          text: "(?:Applications|Don.?t allow|Allow Amber to send you notifications\\?|Let app always run in background\\?)"
      - runFlow:
          when:
            visible:
              text: "Don.?t allow"
          commands:
            - tapOn:
                text: "Don.?t allow"
      - runFlow:
          when:
            visible:
              text: "Let app always run in background\\?"
          commands:
            - tapOn: "Allow"
      - assertVisible: "Applications"

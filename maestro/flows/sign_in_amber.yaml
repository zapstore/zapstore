appId: dev.zapstore.app
---
# =============================================================
# Sub-flow: Sign in with the test automation account via Amber
#
# Navigates to Profile tab and ensures the test account is active.
# If signed in with a different account, signs out first.
# If not signed in, signs in via Amber.
#
# Test account npub: npub1lhrt8n340j83f8umlm7lc23lrfkj7fd22ynkrh4zn8mc4tltqrns4fkp3n
# (see test/fixtures/test-account.env for full keypair)
#
# Prerequisites:
#   - Amber signer app installed with test account imported
# =============================================================

# Dismiss Android notification permission dialog if shown
- runFlow:
    when:
      visible: "Allow"
    commands:
      - tapOn: "Allow"

# Wait for the app to fully load (tab bar must be visible)
- assertVisible:
    text: ".*Tab 3 of 3"

- tapOn:
    text: ".*Tab 3 of 3"
    label: "Tap Profile tab"
- tapOn:
    text: ".*Tab 3 of 3"
    label: "Tap Profile tab again to reset to root"

- waitForAnimationToEnd

# Scroll to find sign-in/sign-out (profile page may not start at top)
- scrollUntilVisible:
    element:
      text: "(?:Sign in with Amber|Sign Out)"
    direction: UP

# If signed in with wrong account, sign out first
- runFlow:
    when:
      visible: "Sign Out"
    commands:
      - runFlow:
          when:
            notVisible: "npub1lhrt"
          commands:
            - tapOn: "Sign Out"
            - assertVisible: "Sign in with Amber"

# If not signed in, sign in via Amber
- runFlow:
    when:
      visible: "Sign in with Amber"
    commands:
      - tapOn: "Sign in with Amber"
      - assertVisible: "Connect"
      - tapOn: "Connect"
      - scrollUntilVisible:
          element: "Sign Out"
          direction: UP

# After Amber sign-in, app may return to a different tab â€” go back to Profile
- tapOn:
    text: ".*Tab 3 of 3"
    label: "Navigate back to Profile tab"

- waitForAnimationToEnd

# Verify we're signed in
- scrollUntilVisible:
    element:
      text: "(?:Sign Out|npub1lhrt)"
    direction: UP

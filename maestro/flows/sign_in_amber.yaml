appId: dev.zapstore.app
---
# =============================================================
# Sub-flow: Sign in with the test automation account via Amber
#
# Navigates to Profile tab and ensures the test account is active.
# If signed in with a different account, signs out first.
# If not signed in, signs in via Amber.
# =============================================================

# Dismiss Android notification permission dialog if shown
- runFlow:
    when:
      visible: "Allow"
    commands:
      - tapOn: "Allow"

# Handle Android background execution prompt from Amber
- runFlow:
    when:
      visible:
        text: "Let app always run in background\\?"
    commands:
      - tapOn: "Allow"

- tapOn:
    text: ".*Tab 3 of 3"
    label: "Tap Profile tab"

# If signed in with wrong account, sign out first
- runFlow:
    when:
      visible: "Sign Out"
    commands:
      - runFlow:
          when:
            notVisible: "npub1lhrt"
          commands:
            - tapOn: "Sign Out"
            - assertVisible: "Sign in with Amber"

# If not signed in, sign in via Amber
- runFlow:
    when:
      visible: "Sign in with Amber"
    commands:
      - tapOn: "Sign in with Amber"
      - assertVisible:
          text: "(?:Connect|Permission Needed)"
      - runFlow:
          when:
            visible: "Permission Needed"
          commands:
            - tapOn: "Allow"
      - runFlow:
          when:
            visible:
              text: "Let app always run in background\\?"
          commands:
            - tapOn: "Allow"
      - tapOn: "Connect"

# After Amber sign-in, app may return to a different tab â€” go back to Profile
- tapOn:
    text: ".*Tab 3 of 3"
    label: "Navigate back to Profile tab"

# Verify we're signed in
- assertVisible:
    text: "(?:Sign Out|npub1lhrt)"

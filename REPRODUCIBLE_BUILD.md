# Reproducible builds (Android)

This project aims to make **byte-for-byte reproducible** Android APK builds.

For reproducibility, always compare **unsigned APKs** (or APKs signed with the exact same keystore + config). Unsigned is simpler and matches how **F-Droid builds (then re-signs)**.

## What is pinned / stabilized

- **Flutter SDK**: pinned via `.fvmrc` (do not use `stable`).
- **Dart/Flutter packages**: pinned via `pubspec.lock`.
- **Gradle**: pinned via `android/gradle/wrapper/gradle-wrapper.properties`.
- **Java**: use **JDK 17** (changing JDK can change bytecode/packaging).
- **SOURCE_DATE_EPOCH**: set to the current commit timestamp to stabilize time-based metadata.
- **Archive determinism**: Gradle archive tasks use stable ordering and no timestamps (`android/build.gradle.kts`).
- **Signing**: `release` is **signed only when a complete `android/key.properties` is present**; otherwise **release builds are unsigned** (`android/app/build.gradle.kts`).

## Requirements

- **FVM** installed
- **JDK 17**
  - Examples (optional):
    - macOS: `export JAVA_HOME=$(/usr/libexec/java_home -v 17)`
    - Ubuntu/Debian: `export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64`
  - Always print the version: `java -version`

## Build (unsigned release)

Important: ensure `android/key.properties` is **absent** (or incomplete) so the APK is **not signed**.

```bash
# Standard reproducible-build timestamp (ties "build time" to the commit)
export SOURCE_DATE_EPOCH="$(git log -1 --pretty=%ct)"

java -version

fvm install
fvm flutter --version

# Must use the lockfile exactly
fvm flutter pub get --enforce-lockfile

# Build unsigned release APKs
fvm flutter build apk --release --split-per-abi
```

Outputs:

- APKs: `build/app/outputs/flutter-apk/`

## Verify reproducibility

Build twice in clean environments (or two different machines/CI runs), then compare the unsigned artifacts.

Example:

```bash
shasum -a 256 build/app/outputs/flutter-apk/*.apk
```

If hashes differ, use `diffoscope` (recommended) to inspect where the difference comes from.

## Docker proof (recommended)

This is the most \"honest\" way to prove reproducibility because it removes most differences from your host environment.

Requirements:
- Docker
- Internet access on first run (toolchain + dependencies need to be downloaded)

Run:

```bash
bash repro/prove_repro.sh
```

Notes:
- Builds happen in **two isolated linux/amd64 containers** (A and B) with **pinned** Flutter + Android cmdline-tools downloads (SHA-256 verified).
- On Apple Silicon, `linux/amd64` runs under emulation and may be unstable for Flutter/Gradle builds. If you hit Dart VM crashes like `Unexpected EINTR errno`, run this script on an **x86_64 Linux** machine or CI runner (this is the strongest proof anyway).
- The script copies the repo into the container filesystem before building (avoids macOS bind-mount quirks).
- Default builds a **single** `release` APK (no split). Use `REPRO_SPLIT_PER_ABI=1` for the split-per-ABI hard mode.
- Outputs are written to `.repro_out/` (ignored by git).

## Notes for F-Droid

- F-Droid will build from source and **re-sign** the APK.
- For reproducibility checks, compare the **unsigned** APK generated by the build step above (same source revision + same pinned toolchain).
